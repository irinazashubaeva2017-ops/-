<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TEQRA DUO</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0e1116;
            color: #e5e7eb;
            -webkit-tap-highlight-color: transparent;
        }

        .app {
            max-width: 430px;
            margin: auto;
            padding: 20px;
            box-sizing: border-box;
            min-height: 100vh;
            padding-bottom: 50px;
        }

        .title {
            text-align: center;
            font-size: 14px;
            letter-spacing: 3px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .balance-card {
            background: linear-gradient(145deg, #1f2937, #111827);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid #374151;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .balance-label {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 38px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .cardRow {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .card {
            flex: 1;
            background: #161b22;
            border: 1px solid #22262e;
            border-radius: 16px;
            padding: 15px;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
            color: #fff;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            opacity: 0.8;
        }

        .highlight { color: #fff; font-weight: 600; }

        .switch {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            background: #161b22;
            padding: 4px;
            border-radius: 16px;
            border: 1px solid #22262e;
        }

        .switch button {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: #9ca3af;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .switch button.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        
        /* –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü—ñ—ó */
        .switch button#expenseBtn.active {
            background: #ef4444;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        .switch button#incomeBtn.active {
            background: #22c55e;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        }

        input {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: 1px solid #2a2f38;
            background: #0d1117;
            color: white;
            margin-bottom: 10px;
            box-sizing: border-box;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        input:focus {
            border-color: #3b82f6;
        }

        button.main {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: none;
            background: #3b82f6;
            color: white;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 25px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        button.main:active {
            transform: scale(0.98);
        }

        .list-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            padding-left: 5px;
            color: #9ca3af;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #161b22;
            border: 1px solid #22262e;
            border-radius: 12px;
            font-size: 13px;
        }

        .income-text { color: #22c55e; font-weight: 600; }
        .expense-text { color: #ef4444; font-weight: 600; }

        .meta {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-left: 10px;
        }

        .actions span {
            cursor: pointer;
            font-size: 16px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .actions span:hover { opacity: 1; }

        .analytics {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #22262e;
        }

        .cat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #1f242c;
            font-size: 12px;
        }

        .denied {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #ef4444;
        }
    </style>
</head>

<body>

<div id="denied" class="denied" style="display:none;">
    ‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ
</div>

<div class="app" id="app" style="display:none;">

    <div class="title">TEQRA ‚Ä¢ DUO</div>
    
    <div class="balance-card">
        <div class="balance-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å</div>
        <div class="balance-amount" id="totalBalance">0</div>
        <div style="font-size: 12px; margin-top: 5px; color: #9ca3af;">
            –í–∏—Ç—Ä–∞—á–µ–Ω–æ –≤—ñ–¥ –¥–æ—Ö–æ–¥—É: <span id="percentUsed" style="color:#fff">0%</span>
        </div>
    </div>

    <div class="cardRow">
        <div class="card">
            <div class="user-title">–Ü—Ä–∞</div>
            <div class="stat-row"><span>–í—Ö—ñ–¥:</span> <span class="highlight" id="iraIncome">0</span></div>
            <div class="stat-row"><span>–í–∏—Ö—ñ–¥:</span> <span class="highlight" id="iraExpense">0</span></div>
            <div style="margin-top:5px; padding-top:5px; border-top:1px solid #2a2f38" class="stat-row">
                <span>–ë–∞–ª:</span> <span style="color:#3b82f6" id="iraBalance">0</span>
            </div>
        </div>
        <div class="card">
            <div class="user-title">–ú—ñ—à–∞</div>
            <div class="stat-row"><span>–í—Ö—ñ–¥:</span> <span class="highlight" id="mishaIncome">0</span></div>
            <div class="stat-row"><span>–í–∏—Ö—ñ–¥:</span> <span class="highlight" id="mishaExpense">0</span></div>
            <div style="margin-top:5px; padding-top:5px; border-top:1px solid #2a2f38" class="stat-row">
                <span>–ë–∞–ª:</span> <span style="color:#3b82f6" id="mishaBalance">0</span>
            </div>
        </div>
    </div>

    <div class="switch">
        <button id="iraBtn" onclick="window.setUser('–Ü—Ä–∞')" class="active">–Ü—Ä–∞</button>
        <button id="mishaBtn" onclick="window.setUser('–ú—ñ—à–∞')">–ú—ñ—à–∞</button>
    </div>

    <div class="switch">
        <button id="incomeBtn" onclick="window.setType('income')" class="active">–î–æ—Ö—ñ–¥ (+)</button>
        <button id="expenseBtn" onclick="window.setType('expense')">–í–∏—Ç—Ä–∞—Ç–∞ (-)</button>
    </div>

    <input type="text" inputmode="decimal" id="amount" placeholder="–°—É–º–∞ (–Ω–∞–ø—Ä. 500)" onfocus="this.select()">
    <input type="text" id="category" placeholder="–ö–∞—Ç–µ–≥–æ—Ä—ñ—è (–Ω–∞–ø—Ä. –ö–∞–≤–∞)">

    <button class="main" onclick="window.addOperation()" id="addBtn">–î–æ–¥–∞—Ç–∏</button>

    <div class="list-header">–Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π</div>
    <div id="list"></div>

    <div class="analytics">
        <div class="list-header">–¢–æ–ø –≤–∏—Ç—Ä–∞—Ç –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏</div>
        <div id="analyticsBox"></div>
    </div>

</div>

<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase (–¢–≤–æ—ó –∫–ª—é—á—ñ)
    const firebaseConfig = {
        apiKey: "AIzaSyBSCke0wwX9GbZRiw1xG97v7KWRUERQsc",
        authDomain: "finance-eec75.firebaseapp.com",
        projectId: "finance-eec75",
        storageBucket: "finance-eec75.appspot.com",
        messagingSenderId: "386010317837",
        appId: "1:386010317837:web:88a24adc90b403e42a4144"
    };

    // Telegram ID (–î–æ–¥–∞–≤ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É, —â–æ–± –ø—Ä–∞—Ü—é–≤–∞–ª–æ)
    const allowed = [7255848995, 921509542]; 
    
    const tg = window.Telegram.WebApp;
    tg.expand(); // –†–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω
    
    const uid = tg.initDataUnsafe?.user?.id;

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É (–ü—Ä–æ—Å—Ç–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç)
    // –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –±–µ–∑ –¢–ì –¥–ª—è —Ç–µ—Å—Ç—É - –º–æ–∂–Ω–∞ –∑–∞–∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏ if/else
    if (uid && !allowed.includes(uid)) {
        document.getElementById("denied").style.display = "flex";
    } else {
        document.getElementById("app").style.display = "block";
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ref = collection(db, "operations");

    let currentUser = "–Ü—Ä–∞";
    let currentType = "income";

    // --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ---
    
    // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–æ—à–µ–π (1000 -> 1 000)
    function formatMoney(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (–ø—Ä–∏–≤'—è–∑–∫–∞ –¥–æ window) ---

    window.setUser = function(u) {
        currentUser = u;
        document.getElementById("iraBtn").classList.toggle("active", u === "–Ü—Ä–∞");
        document.getElementById("mishaBtn").classList.toggle("active", u === "–ú—ñ—à–∞");
        tg.HapticFeedback.impactOccurred('light');
    }

    window.setType = function(t) {
        currentType = t;
        document.getElementById("incomeBtn").classList.toggle("active", t === "income");
        document.getElementById("expenseBtn").classList.toggle("active", t === "expense");
        
        // –ó–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä –∫–Ω–æ–ø–∫–∏ "–î–æ–¥–∞—Ç–∏" –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É
        const btn = document.getElementById("addBtn");
        if(t === 'income') btn.style.background = '#22c55e';
        else btn.style.background = '#ef4444';
        
        tg.HapticFeedback.impactOccurred('light');
    }

    window.addOperation = async function() {
        const btn = document.getElementById("addBtn");
        const amountInput = document.getElementById("amount");
        const catInput = document.getElementById("category");

        // –ó–∞–º—ñ–Ω–∞ –∫–æ–º–∏ –Ω–∞ –∫—Ä–∞–ø–∫—É –¥–ª—è –¥—Ä–æ–±–Ω–∏—Ö —á–∏—Å–µ–ª
        let val = amountInput.value.replace(',', '.');
        const amount = parseFloat(val);
        const category = catInput.value.trim();

        if (!amount || !category) {
            tg.HapticFeedback.notificationOccurred('error');
            return;
        }

        btn.disabled = true;
        btn.innerText = "‚è≥";

        try {
            await addDoc(ref, {
                amount,
                category,
                type: currentType,
                author: currentUser,
                createdAt: serverTimestamp() // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å–µ—Ä–≤–µ—Ä–Ω–∏–π —á–∞—Å
            });

            amountInput.value = "";
            catInput.value = "";
            tg.HapticFeedback.notificationOccurred('success');
        } catch (e) {
            alert("–ü–æ–º–∏–ª–∫–∞: " + e.message);
        }

        btn.disabled = false;
        btn.innerText = "–î–æ–¥–∞—Ç–∏";
        amountInput.focus();
    }

    window.deleteOperation = async function(id) {
        if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?")) {
            await deleteDoc(doc(db, "operations", id));
            tg.HapticFeedback.impactOccurred('medium');
        }
    }

    window.editOperation = async function(id, oldAmount, oldCategory) {
        const newAmount = prompt("–ù–æ–≤–∞ —Å—É–º–∞:", oldAmount);
        if (newAmount === null) return;
        
        const newCategory = prompt("–ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è:", oldCategory);
        if (newCategory === null) return;

        let val = newAmount.replace(',', '.');
        
        await updateDoc(doc(db, "operations", id), {
            amount: parseFloat(val),
            category: newCategory
        });
        tg.HapticFeedback.notificationOccurred('success');
    }

    // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–ú–∞–ª—é–≤–∞–Ω–Ω—è) ---

    function render(snapshot) {
        let iraIncome = 0, iraExpense = 0;
        let mishaIncome = 0, mishaExpense = 0;
        let expenseCategories = {}; // –†–∞—Ö—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –≤–∏—Ç—Ä–∞—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö

        const list = document.getElementById("list");
        list.innerHTML = "";

        // –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const id = docSnap.id;
            
            // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –±–∏—Ç–∏—Ö –¥–∞–Ω–∏—Ö –±–µ–∑ —Å—É–º–∏
            if(!d.amount) return;

            // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –±–∞–ª–∞–Ω—Å—ñ–≤
            if (d.author === "–Ü—Ä–∞") {
                if (d.type === "income") iraIncome += d.amount;
                else iraExpense += d.amount;
            } else {
                if (d.type === "income") mishaIncome += d.amount;
                else mishaExpense += d.amount;
            }

            // –ó–±–∏—Ä–∞—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –¢–Ü–õ–¨–ö–ò –¥–ª—è –≤–∏—Ç—Ä–∞—Ç
            if (d.type === "expense") {
                expenseCategories[d.category] = (expenseCategories[d.category] || 0) + d.amount;
            }

            // –ú–∞–ª—é—î–º–æ –µ–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫—É
            const div = document.createElement("div");
            div.className = "item";
            
            const sign = d.type === "income" ? "+" : "-";
            const colorClass = d.type === "income" ? "income-text" : "expense-text";
            
            div.innerHTML = `
                <div>
                    <div style="font-weight:600">${d.category}</div>
                    <div class="meta">${d.author}</div>
                </div>
                <div style="text-align:right">
                    <span class="${colorClass}">${sign} ${formatMoney(d.amount)}</span>
                    <div class="actions">
                        <span onclick="window.editOperation('${id}', ${d.amount}, '${d.category}')">‚úèÔ∏è</span>
                        <span onclick="window.deleteOperation('${id}')">üóë</span>
                    </div>
                </div>`;
            
            list.appendChild(div);
        });

        // –û–Ω–æ–≤–ª—é—î–º–æ —Ü–∏—Ñ—Ä–∏ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ
        document.getElementById("iraIncome").innerText = formatMoney(iraIncome);
        document.getElementById("iraExpense").innerText = formatMoney(iraExpense);
        document.getElementById("iraBalance").innerText = formatMoney(iraIncome - iraExpense);

        document.getElementById("mishaIncome").innerText = formatMoney(mishaIncome);
        document.getElementById("mishaExpense").innerText = formatMoney(mishaExpense);
        document.getElementById("mishaBalance").innerText = formatMoney(mishaIncome - mishaExpense);

        const totalIncome = iraIncome + mishaIncome;
        const totalExpense = iraExpense + mishaExpense;
        const totalBalance = (iraIncome - iraExpense) + (mishaIncome - mishaExpense);
        
        // –í—ñ–¥—Å–æ—Ç–æ–∫ –≤–∏—Ç—Ä–∞—Ç –≤—ñ–¥–Ω–æ—Å–Ω–æ –¥–æ—Ö–æ–¥—É
        const percent = totalIncome ? ((totalExpense / totalIncome) * 100).toFixed(1) : 0;

        document.getElementById("totalBalance").innerText = formatMoney(totalBalance) + " ‚Ç¥";
        document.getElementById("percentUsed").innerText = percent + "%";

        // –ú–∞–ª—é—î–º–æ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É (–¢—ñ–ª—å–∫–∏ –≤–∏—Ç—Ä–∞—Ç–∏, —Å–æ—Ä—Ç—É—î–º–æ –≤—ñ–¥ –Ω–∞–π–±—ñ–ª—å—à–∏—Ö)
        const analyticsBox = document.getElementById("analyticsBox");
        analyticsBox.innerHTML = "";
        
        const sortedCats = Object.entries(expenseCategories).sort((a, b) => b[1] - a[1]);
        
        if (sortedCats.length === 0) {
            analyticsBox.innerHTML = "<div style='text-align:center; opacity:0.5; padding:10px'>–ü–æ–∫–∏ –Ω–µ–º–∞—î –≤–∏—Ç—Ä–∞—Ç</div>";
        }

        sortedCats.forEach(([cat, sum]) => {
            const row = document.createElement("div");
            row.className = "cat-row";
            row.innerHTML = `<span>${cat}</span> <span style="color:#ef4444">-${formatMoney(sum)}</span>`;
            analyticsBox.appendChild(row);
        });
    }

    // –°–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω–∏ –≤ –±–∞–∑—ñ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
    const q = query(ref, orderBy("createdAt", "desc"));
    onSnapshot(q, render);

</script>

</body>
</html>
