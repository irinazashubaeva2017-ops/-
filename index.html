<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TEQRA DUO</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --bg-color: #0e1116;
            --card-bg: rgba(22, 27, 34, 0.7);
            --accent: #3b82f6;
            --success: #22c55e;
            --error: #ef4444;
            --text-main: #e5e7eb;
            --text-dim: #9ca3af;
            --border: rgba(255, 255, 255, 0.08);
        }

        html, body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .app {
            max-width: 430px;
            margin: auto;
            padding: 16px;
            box-sizing: border-box;
            min-height: 100vh;
            backdrop-filter: blur(10px);
        }

        /* Header & Balance */
        .title {
            text-align: center;
            font-size: 12px;
            letter-spacing: 4px;
            font-weight: 800;
            color: var(--accent);
            margin: 10px 0 25px;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .balance-card {
            background: linear-gradient(160deg, #1f2937 0%, #0f172a 100%);
            padding: 24px;
            border-radius: 24px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(59,130,246,0.1) 0%, transparent 70%);
        }

        .balance-label { font-size: 13px; color: var(--text-dim); margin-bottom: 8px; }
        .balance-amount { font-size: 42px; font-weight: 800; letter-spacing: -1px; }

        /* User Cards */
        .cardRow { display: flex; gap: 10px; margin-bottom: 20px; }
        .card {
            flex: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 16px;
            backdrop-filter: blur(5px);
        }

        .user-title { font-weight: 800; font-size: 15px; margin-bottom: 10px; color: #fff; display: flex; align-items: center; gap: 6px; }
        .user-title::before { content: ''; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; }

        .stat-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; color: var(--text-dim); }
        .stat-row b { color: var(--text-main); }

        /* Controls */
        .switch-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .switch {
            display: flex;
            background: #161b22;
            padding: 4px;
            border-radius: 14px;
            border: 1px solid var(--border);
        }

        .switch button {
            flex: 1;
            padding: 12px;
            border-radius: 11px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .switch button.active { background: #30363d; color: white; }
        #iraBtn.active { color: var(--accent); }
        #mishaBtn.active { color: #a855f7; }
        
        #incomeBtn.active { background: var(--success); color: white; }
        #expenseBtn.active { background: var(--error); color: white; }

        /* Inputs */
        .input-box { position: relative; margin-bottom: 10px; }
        input {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: #161b22;
            color: white;
            box-sizing: border-box;
            font-size: 16px;
            outline: none;
            transition: all 0.2s;
        }
        input:focus { border-color: var(--accent); background: #1c2128; }

        button.main {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: none;
            background: var(--accent);
            color: white;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            cursor: pointer;
            transition: 0.2s;
        }
        button.main:active { transform: scale(0.97); opacity: 0.9; }

        /* List & History */
        .date-divider {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-dim);
            margin: 20px 0 10px 5px;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            margin-bottom: 10px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .item-info b { display: block; font-size: 14px; margin-bottom: 2px; }
        .item-info span { font-size: 11px; color: var(--text-dim); background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; }

        .item-amount { text-align: right; font-weight: 700; font-size: 15px; }
        .item-actions { font-size: 18px; margin-top: 4px; opacity: 0.4; display: flex; gap: 10px; justify-content: flex-end; }

        /* Analytics */
        .analytics { margin-top: 30px; background: rgba(255,255,255,0.02); padding: 15px; border-radius: 20px; }
        .cat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 5px;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }

        .denied { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; gap: 10px; }
    </style>
</head>

<body>

<div id="denied" class="denied" style="display:none;">
    <span style="font-size: 50px;">üîí</span>
    <div style="font-weight: bold; color: var(--error)">–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ</div>
</div>

<div class="app" id="app" style="display:none;">

    <div class="title">TEQRA DUO SYSTEM</div>
    
    <div class="balance-card">
        <div class="balance-label">–°–ø—ñ–ª—å–Ω–∏–π –±—é–¥–∂–µ—Ç</div>
        <div class="balance-amount" id="totalBalance">0 ‚Ç¥</div>
        <div style="margin-top: 12px;">
            <progress id="budgetProgress" value="0" max="100" style="width: 100%; height: 6px; border-radius: 10px;"></progress>
            <div style="font-size: 11px; margin-top: 6px; color: var(--text-dim);">
                –í–∏—Ç—Ä–∞—á–µ–Ω–æ <span id="percentUsed" style="color: #fff; font-weight: bold;">0%</span> –¥–æ—Ö–æ–¥—É
            </div>
        </div>
    </div>

    <div class="cardRow">
        <div class="card">
            <div class="user-title">–Ü—Ä–∞</div>
            <div class="stat-row">–í—Ö—ñ–¥: <b id="iraIncome">0</b></div>
            <div class="stat-row">–í–∏—Ö—ñ–¥: <b id="iraExpense">0</b></div>
        </div>
        <div class="card">
            <div class="user-title" style="color: #a855f7;">–ú—ñ—à–∞</div>
            <div class="stat-row">–í—Ö—ñ–¥: <b id="mishaIncome">0</b></div>
            <div class="stat-row">–í–∏—Ö—ñ–¥: <b id="mishaExpense">0</b></div>
        </div>
    </div>

    <div class="switch-group">
        <div class="switch">
            <button id="iraBtn" onclick="window.setUser('–Ü—Ä–∞')" class="active">–Ü—Ä–∞</button>
            <button id="mishaBtn" onclick="window.setUser('–ú—ñ—à–∞')">–ú—ñ—à–∞</button>
        </div>

        <div class="switch">
            <button id="incomeBtn" onclick="window.setType('income')" class="active">–î–æ—Ö—ñ–¥</button>
            <button id="expenseBtn" onclick="window.setType('expense')">–í–∏—Ç—Ä–∞—Ç–∞</button>
        </div>
    </div>

    <div class="input-box">
        <input type="text" inputmode="decimal" id="amount" placeholder="–°—É–º–∞">
    </div>
    <div class="input-box">
        <input type="text" id="category" placeholder="–ö–∞—Ç–µ–≥–æ—Ä—ñ—è (–∫–∞–≤–∞, –æ—Ä–µ–Ω–¥–∞...)" list="suggestions">
        <datalist id="suggestions">
            <option value="–ü—Ä–æ–¥—É–∫—Ç–∏">
            <option value="–ö–∞–≤–∞">
            <option value="–†–µ—Å—Ç–æ—Ä–∞–Ω–∏">
            <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">
            <option value="–ñ–∏—Ç–ª–æ">
            <option value="–†–æ–∑–≤–∞–≥–∏">
        </datalist>
    </div>

    <button class="main" onclick="window.addOperation()" id="addBtn">–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</button>

    <div id="list"></div>

    <div class="analytics">
        <div style="font-weight: 800; font-size: 14px; margin-bottom: 15px;">–ê–ù–ê–õ–Ü–¢–ò–ö–ê –í–ò–¢–†–ê–¢</div>
        <div id="analyticsBox"></div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBSCke0wwX9GbZRiw1xG97v7KWRUERQsc",
        authDomain: "finance-eec75.firebaseapp.com",
        projectId: "finance-eec75",
        storageBucket: "finance-eec75.appspot.com",
        messagingSenderId: "386010317837",
        appId: "1:386010317837:web:88a24adc90b403e42a4144"
    };

    const allowed = [7255848995, 921509542]; 
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();
    
    const uid = tg.initDataUnsafe?.user?.id;

    if (uid && !allowed.includes(uid)) {
        document.getElementById("denied").style.display = "flex";
    } else {
        document.getElementById("app").style.display = "block";
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ref = collection(db, "operations");

    let currentUser = "–Ü—Ä–∞";
    let currentType = "income";

    const formatMoney = (n) => new Intl.NumberFormat('uk-UA').format(n);

    window.setUser = (u) => {
        currentUser = u;
        document.getElementById("iraBtn").classList.toggle("active", u === "–Ü—Ä–∞");
        document.getElementById("mishaBtn").classList.toggle("active", u === "–ú—ñ—à–∞");
        tg.HapticFeedback.impactOccurred('light');
    };

    window.setType = (t) => {
        currentType = t;
        document.getElementById("incomeBtn").classList.toggle("active", t === "income");
        document.getElementById("expenseBtn").classList.toggle("active", t === "expense");
        document.getElementById("addBtn").style.background = t === 'income' ? 'var(--success)' : 'var(--error)';
        tg.HapticFeedback.impactOccurred('light');
    };

    window.addOperation = async () => {
        const amountEl = document.getElementById("amount");
        const catEl = document.getElementById("category");
        const amount = parseFloat(amountEl.value.replace(',', '.'));
        const category = catEl.value.trim();

        if (!amount || !category) {
            tg.HapticFeedback.notificationOccurred('error');
            return;
        }

        const btn = document.getElementById("addBtn");
        btn.disabled = true;
        
        try {
            await addDoc(ref, {
                amount, category, type: currentType,
                author: currentUser, createdAt: serverTimestamp()
            });
            amountEl.value = "";
            catEl.value = "";
            tg.HapticFeedback.notificationOccurred('success');
        } catch (e) {
            tg.showAlert("–ü–æ–º–∏–ª–∫–∞ –ë–î");
        }
        btn.disabled = false;
    };

    window.deleteOperation = async (id) => {
        tg.showConfirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?", async (confirmed) => {
            if (confirmed) {
                await deleteDoc(doc(db, "operations", id));
                tg.HapticFeedback.impactOccurred('medium');
            }
        });
    };

    function render(snapshot) {
        let stats = { –Ü—Ä–∞: { in: 0, out: 0 }, –ú—ñ—à–∞: { in: 0, out: 0 } };
        let categories = {};
        const list = document.getElementById("list");
        list.innerHTML = "";

        let lastDate = "";

        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            if (!d.amount || !d.createdAt) return;

            // Stats
            stats[d.author][d.type === 'income' ? 'in' : 'out'] += d.amount;
            if (d.type === 'expense') categories[d.category] = (categories[d.category] || 0) + d.amount;

            // Date Grouping
            const date = d.createdAt.toDate().toLocaleDateString('uk-UA', { day: 'numeric', month: 'long' });
            if (date !== lastDate) {
                const divDate = document.createElement("div");
                divDate.className = "date-divider";
                divDate.innerText = date;
                list.appendChild(divDate);
                lastDate = date;
            }

            const item = document.createElement("div");
            item.className = "item";
            item.innerHTML = `
                <div class="item-info">
                    <b>${d.category}</b>
                    <span>${d.author}</span>
                </div>
                <div>
                    <div class="item-amount" style="color: ${d.type === 'income' ? 'var(--success)' : 'var(--error)'}">
                        ${d.type === 'income' ? '+' : '-'}${formatMoney(d.amount)}
                    </div>
                    <div class="item-actions">
                        <span onclick="deleteOperation('${docSnap.id}')">üóë</span>
                    </div>
                </div>
            `;
            list.appendChild(item);
        });

        // UI Updates
        document.getElementById("iraIncome").innerText = formatMoney(stats.–Ü—Ä–∞.in);
        document.getElementById("iraExpense").innerText = formatMoney(stats.–Ü—Ä–∞.out);
        document.getElementById("mishaIncome").innerText = formatMoney(stats.–ú—ñ—à–∞.in);
        document.getElementById("mishaExpense").innerText = formatMoney(stats.–ú—ñ—à–∞.out);

        const totalIn = stats.–Ü—Ä–∞.in + stats.–ú—ñ—à–∞.in;
        const totalOut = stats.–Ü—Ä–∞.out + stats.–ú—ñ—à–∞.out;
        const balance = totalIn - totalOut;

        document.getElementById("totalBalance").innerText = formatMoney(balance) + " ‚Ç¥";
        const percent = totalIn ? Math.min((totalOut / totalIn) * 100, 100).toFixed(1) : 0;
        document.getElementById("percentUsed").innerText = percent + "%";
        document.getElementById("budgetProgress").value = percent;

        // Analytics
        const analBox = document.getElementById("analyticsBox");
        analBox.innerHTML = Object.entries(categories).sort((a,b) => b[1]-a[1]).map(([c, s]) => `
            <div class="cat-row">
                <span>${c}</span>
                <b style="color: var(--error)">-${formatMoney(s)}</b>
            </div>
        `).join('') || '<div style="opacity:0.5; text-align:center">–ù–µ–º–∞—î –≤–∏—Ç—Ä–∞—Ç</div>';
    }

    onSnapshot(query(ref, orderBy("createdAt", "desc")), render);

</script>
</body>
</html>
