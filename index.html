<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TEQRA Finance</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,sans-serif;
background:#0e1116;
color:#e5e7eb;
touch-action:manipulation;
}

.app{
max-width:430px;
margin:auto;
padding:28px 20px 40px;
min-height:100vh;
}

.title{
text-align:center;
font-size:15px;
letter-spacing:3px;
opacity:0.5;
margin-bottom:25px;
}

.balance{
text-align:center;
font-size:42px;
font-weight:700;
margin-bottom:25px;
transition:0.3s;
}

.positive{color:#22c55e}
.negative{color:#ef4444}

.switch{
display:flex;
gap:10px;
margin-bottom:12px;
}

.switch button{
flex:1;
padding:12px;
border-radius:16px;
border:1px solid #2a2f38;
background:#161b22;
color:#9ca3af;
font-weight:500;
}

.active{
background:#1f2937 !important;
color:white !important;
border-color:#3b82f6 !important;
}

input{
width:100%;
padding:14px;
border-radius:16px;
border:1px solid #2a2f38;
background:#161b22;
color:white;
margin-bottom:12px;
font-size:14px;
outline:none;
}

input:focus{
border-color:#3b82f6;
}

button.main{
width:100%;
padding:14px;
border-radius:18px;
border:none;
background:#3b82f6;
color:white;
font-weight:600;
margin-bottom:20px;
}

.item{
display:flex;
justify-content:space-between;
padding:14px 0;
border-bottom:1px solid #1f242c;
font-size:14px;
}

.actions span{
cursor:pointer;
font-size:12px;
margin-left:10px;
opacity:0.6;
}

.income{color:#22c55e}
.expense{color:#ef4444}

.denied{
display:flex;
justify-content:center;
align-items:center;
height:100vh;
font-size:18px;
}
</style>
</head>

<body>

<div id="denied" class="denied" style="display:none;">
Доступ заборонено
</div>

<div class="app" id="app" style="display:none;">

<div class="title">TEQRA • PRIVATE FINANCE</div>

<div class="balance" id="total">0 грн</div>

<div class="switch">
<button id="iraBtn" onclick="setUser('Іра')" class="active">Іра</button>
<button id="mishaBtn" onclick="setUser('Міша')">Міша</button>
</div>

<div class="switch">
<button id="incomeBtn" onclick="setType('income')" class="active">Дохід</button>
<button id="expenseBtn" onclick="setType('expense')">Витрата</button>
</div>

<input type="number" inputmode="decimal" id="amount" placeholder="Сума">
<input type="text" id="category" placeholder="Категорія">

<button class="main" onclick="addOrUpdate()">Додати</button>

<div id="list"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSCke0wwX9GbZRiw1xG97v7KWRUERQsc",
  authDomain: "finance-eec75.firebaseapp.com",
  projectId: "finance-eec75",
  storageBucket: "finance-eec75.appspot.com",
  messagingSenderId: "386010317837",
  appId: "1:386010317837:web:88a24adc90b403e42a4144"
};

const allowedIds = [7255848995, 921509542];

const tg = window.Telegram.WebApp;
tg.ready();
const userId = tg.initDataUnsafe?.user?.id;

if(!allowedIds.includes(userId)){
  document.getElementById("denied").style.display="flex";
}else{
  document.getElementById("app").style.display="block";
}

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const operationsRef = collection(db, "operations");

let currentUser="Іра";
let currentType="income";
let editId=null;

window.setUser=function(user){
  currentUser=user;
  document.getElementById("iraBtn").classList.toggle("active",user==="Іра");
  document.getElementById("mishaBtn").classList.toggle("active",user==="Міша");
}

window.setType=function(type){
  currentType=type;
  document.getElementById("incomeBtn").classList.toggle("active",type==="income");
  document.getElementById("expenseBtn").classList.toggle("active",type==="expense");
}

window.addOrUpdate=async function(){
  const amount=parseFloat(document.getElementById("amount").value);
  const category=document.getElementById("category").value;
  if(!amount||!category)return;

  if(editId){
    await updateDoc(doc(db,"operations",editId),{
      amount,category,type:currentType,author:currentUser
    });
    editId=null;
  }else{
    await addDoc(operationsRef,{
      amount,category,type:currentType,author:currentUser,createdAt:new Date()
    });
  }

  document.getElementById("amount").value="";
  document.getElementById("category").value="";
}

function render(snapshot){
  const list=document.getElementById("list");
  list.innerHTML="";
  let total=0;

  snapshot.forEach(docSnap=>{
    const item=docSnap.data();
    const id=docSnap.id;
    total+=item.type==="income"?item.amount:-item.amount;

    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`
      <div>${item.category} (${item.author})</div>
      <div>
        <span class="${item.type}">
          ${item.type==="income"?"+":"-"} ${item.amount}
        </span>
        <span class="actions">
          <span onclick="editOp('${id}','${item.type}','${item.author}',${item.amount},'${item.category}')">Ред.</span>
          <span onclick="deleteOp('${id}')">Вид.</span>
        </span>
      </div>
    `;
    list.appendChild(div);
  });

  const totalEl=document.getElementById("total");
  totalEl.innerText=total+" грн";
  totalEl.className="balance "+(total>=0?"positive":"negative");
}

window.deleteOp=async function(id){
  await deleteDoc(doc(db,"operations",id));
}

window.editOp=function(id,type,author,amount,category){
  editId=id;
  currentType=type;
  currentUser=author;
  setUser(author);
  setType(type);
  document.getElementById("amount").value=amount;
  document.getElementById("category").value=category;
}

onSnapshot(query(operationsRef,orderBy("createdAt","desc")),render);

</script>

</body>
</html>
